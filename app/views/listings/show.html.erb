<!-- Return links -->
<main class="listing-show">
  <div class="listing-show__return-links">
    <%= link_to "All Listings", listings_path, class: "listing-show__return-links__link" %>
    <span class="listing-show__return-links__spacer">></span>
    <%= link_to @listing.category.name, listings_path, class: "listing-show__return-links__link" %>
    <span class="listing-show__return-links__spacer">></span>
    <span class="listing-show__return-links__current"><%= @listing.title %></span>
  </div>
  
  <section class="listing-show__wrapper">

    <!-- Listing Images -->
    <div class="listing-show__images">
      <% if @listing.images.attached? %>
        <%= image_tag @listing.images[0], class: "listing-show__images__main"%>
        <div class="listing-show__images__thumbnail-container">
          <% (0...@listing.images.count).each do |image| %>
            <%= image_tag @listing.images[image], class: "listing-show__images__thumbnail" %>
          <% end %>
        </div>
      <% end %>
    </div>

    <!-- Listing Text Details -->
    <div class="listing-show__details">
      <h2 class="listing-show__title">
        <%= @listing.title %>
      </h2>
      <h3 class="listing-show__brand">
        <%= @listing.brand.name %>
      </h3>
      <p class="listing-show__description">
        <span>Description:</span> <%= @listing.description %>
      </p>
      <span class="listing-show__condition">
        <span>Condition:</span> <%= @listing.condition %>
      </span>
      <span class="listing-show__price">
        <%= render_price(@listing.sold, @listing.price) %>
      </span>

      <!-- Postage costs -->
      <%= render_postage(@listing.sold, @postage_cost) %>

      <!-- Watchlist -->
      <% if current_user && current_user.id != @listing.user.id %>
        <% if !current_user.profile.listings.include?(@listing) %>
          <span class="listing-show__watchlist">
            Add to <%= link_to "Watchlist", create_watch_path(watch: { listing_id: @listing.id, profile_id: current_user.profile.id}), method: :post %>
          </span>
        <% else %>
          <span class="listing-show__watchlist">
            Remove from <%= link_to "Watchlist", delete_watch_path(current_user.profile.watches.where("listing_id": @listing.id)[0].id), method: :delete %>
          </span>
        <% end %>
      <% end %>

      <!-- Buy and Message -->
      <% if user_signed_in? && current_user.id != @listing.user.id && @listing.sold != true %>
        <button data-stripe="payment" class="listing-show__purchase btn btn-ghost btn-up">Purchase</button>
        <%= link_to "Message", create_conversation_path(sender_id: current_user.id, receiver_id: @listing.user.id), method: :post, class: "listing-show__message btn btn-up btn-ghost" %>
      <% end %>

      <!-- Seller Details -->
      <div class="listing-show__user-details">
        <span class="listing-show__user-details__name">
          <%= link_to @listing.user.username, profile_path(@listing.user.profile.id) %>
        </span>
        <span class="listing-show__user-details__listing-total">
          <%= listing_count(@listing.user.listings) %>
        </span>
      </div>

      <!-- Update/Delete if authorised -->
      <div class="listing-show__user-buttons">
        <% if user_signed_in? && @listing.user_id == current_user.id && @listing.sold != true %>
          <%= link_to "Edit", edit_listing_path(@listing.id), class: "listing-show__user-buttons--edit btn btn-up btn-ghost" %>
          <%= link_to "Delete", delete_listing_path(@listing.id), method: :delete, class: "listing-show__user-buttons--delete btn btn-up btn-ghost" %>
        <% end %>
      </div>
    </div>
  </section>
</main>

<!-- Stripe session -->

<script src="https://js.stripe.com/v3/"></script>

<script>
  document.querySelector("[data-stripe='payment']").addEventListener("click", () => {
    const stripe = Stripe("<%= Rails.application.credentials.dig(:stripe, :public_key) %>");
    stripe.redirectToCheckout({
      sessionId: "<%= @session_id %>"
    });
  });
</script>

<script>
  const thumbnailBox = document.querySelector(".listing-show__images__thumbnail-container")
  const mainImage = document.querySelector(".listing-show__images__main")
  thumbnailBox.addEventListener("click", (e) => {
    const target = e.target.closest(".listing-show__images__thumbnail");
    const src = target.src;
    mainImage.src = src;
  })
</script>